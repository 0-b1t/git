#!/bin/sh

J='-l 4 -j'
G=/pub/software/scm/git &&

cd $HOME/git &&
make clean >/dev/null 2>&1 &&
git reset --hard &&
make clean >/dev/null 2>&1 &&
git checkout master &&
git pull . origin &&
make clean >/dev/null 2>&1 &&

case "$1" in
'')
	echo "* Building all"
	{
		make $J install &&
		make test &&
		make clean &&
		git checkout pu &&
		make $J clean &&
		make test clean
	} >:all.log 2>&1
	;;
maint | master)
	mkdir -p $G/RPMS/i386 $G/RPMS/SRPMS &&

	echo "* Building $1"
	git checkout "$1" &&
	make rpm >./:rpm.log 2>&1 &&
	make $J git >>./:rpm.log 2>&1 &&
	V=`./git --version | sed -e 's/git version //'` &&
	ln git-$V.tar.gz $G/. &&
	ln $HOME/rpms/RPMS/i386/git*-$V-* $G/RPMS/i386/. &&
	ln $HOME/rpms/SRPMS/git-$V-* $G/RPMS/SRPMS/. &&
	rm -fr ./:rpm.log &&
	make clean &&

	: ;;
esac || exit $?

git checkout master
