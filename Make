#!/bin/sh

# DDD=' -DUSE_SYMLINK_HEAD=0'
# PATH=/usr/bin:/bin

G=/opt/packrat/playpen/public/in-place/git/index/gitweb_config.perl
PATH=$HOME/git-master/bin:/usr/bin:/bin
LANG=C
LC_CTYPE=C
export PATH LANG LC_CTYPE

# for now...
#GIT_SVN_NO_LIB=1
#export GIT_SVN_NO_LIB

old_style_def_fix=b79d18c92d9f4841a6a1a29b7b2373a8ff9871e1

head=`git symbolic-ref HEAD 2>/dev/null` &&
branch=`expr "$head" : 'refs/heads/\(.*\)'` || branch=detached

case "$branch" in
next | maint | master | pu)
	d="prefix=$HOME/git-$branch" ;;
snap)
	v=`git describe HEAD`
	expr "$v" : '.*-g[0-9a-f]*$' >/dev/null && {
	    echo >&2 "You are on 'snap' but $v is not an official version."
	    exit 1
	}
	d="prefix=$HOME/git-snap-$v"
	;;
*)
	d="prefix=$HOME/git-test" ;;
esac

: ${O=-O2}

while case $# in 0) break ;; esac
do 
	case "$1" in
	-pedantic)
		o= &&
		rev=$(git-rev-parse HEAD) &&
		case "$(git-merge-base "$old_style_def_fix" "$rev")" in
		$old_style_def_fix)
			o=-Wold-style-definition ;;
		esac
		O="$O -Werror -Wall $o -ansi -pedantic -std=c99"
		;;
	--)
		shift
		break
		;;
	-*)
		echo >&2 "Eh $1?"
		exit 1
		;;
	*)
		break
		;;		
	esac
	shift
done

make $d \
     GITWEB_CONFIG=$G \
     PYTHON_PATH=/usr/bin/python2.4 \
     ETC_GITCONFIG=$d/etc/gitconfig \
     CFLAGS="$O -Wall -Wdeclaration-after-statement -g" \
     "$@"
