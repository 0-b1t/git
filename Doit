#!/bin/sh

: ${J=-j2}

test -z "$(git diff --cached --name-status)" || {
	echo >&2 "Repository unclean."
	exit 1
}
Meta/Make clean >/dev/null 2>&1

: ${branches='next master maint pu'}

nstall=install
for branch in $branches
do
	if git rev-parse --verify refs/heads/$branch 2>/dev/null
	then
		echo "* $branch" &&
		git checkout $branch &&
		Meta/Make -- $J all &&
		Meta/Make -- $J $nstall &&
		Meta/Make test &&
		Meta/Make clean || exit $?
	else
		echo "* No $branch"
	fi
done >./:all.log 2>&1

git checkout master


