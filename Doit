#!/bin/sh

J='-l 2.5 -j'

test -z "$(git diff --cached --name-status)" || {
	echo >&2 "Repository unclean."
	exit 1
}

nstall=install
for branch in naster master maint pu
do
	rm -f ./:$branch.log &&
	if git rev-parse --verify refs/heads/$branch 2>/dev/null
	then
		echo "* $branch" &&
		git checkout $branch || break
		{
		    Meta/Make $J $nstall &&
		    Meta/Make test &&
		    Meta/Make clean
		} >./:$branch.log &&
		nstall=all || exit $?
	else
		echo "* No $branch"
	fi
done
